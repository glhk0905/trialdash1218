<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ¯”è³½å³æ™‚ç›£æ§ Dashboard</title>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system;
  background: #0f0f0f;
  color: #f0f0f0;
}

/* é ‚éƒ¨ */
#topBar {
  position: sticky;
  top: 0;
  z-index: 1000;
  background: #0f0f0f;
  padding: 10px 16px;
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

#judgeToggle {
  background: #3498db;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
}
.judge-mode #judgeToggle { background:#555; }

#lastUpdate {
  font-size: 14px;
  color: #ccc;
  white-space: nowrap;
}

.container {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 12px;
  padding: 12px;
  height: calc(100vh - 56px);
}

.card {
  background: #1a1a1a;
  border-radius: 10px;
  padding: 12px;
  overflow-y: auto;
}

.judge-mode .container { grid-template-columns: 1fr; }
.judge-mode #teamView { display:none; }

h2 { font-size: 26px; margin: 6px 0 12px; }

/* å°éšŠ */
.team {
  border-bottom:1px solid #333;
  padding:8px;
  border-radius:8px;
  margin-bottom:10px;
}

/* ğŸ”´ å°éšŠé¦–æ¬¡å ±åˆ°æœªé½Š 6 */
.team-alert {
  background:#3a0f0f;
  border:2px solid #e74c3c;
}

/* æˆå“¡ */
.member {
  display:inline-block;
  min-width:46px;
  margin:4px;
  padding:6px 0;
  text-align:center;
  font-weight:700;
  border-radius:6px;
  color:#000;
}
.green { background:#2ecc71; }
.red { background:#e74c3c; }
.yellow { background:#f1c40f; }

.team-title {
  font-size:22px;
  font-weight:700;
}

/* å³é‚Šï¼ˆä¿ç•™ï¼Œä¸å†é‡åˆ—ï¼‰ */
</style>
</head>

<body>

<div id="topBar">
  <button id="judgeToggle" onclick="toggleJudgeMode()">ğŸ‘©â€âš–ï¸ é€²å…¥è£åˆ¤æ¨¡å¼</button>
  <div id="lastUpdate">â€”</div>
</div>

<div class="container">
  <div class="card" id="teamView"><h2>ğŸ å°éšŠå³æ™‚ç‹€æ…‹</h2></div>
  <div class="card" id="eventView"><h2>ğŸ¯ æ¯”è³½é …ç›®</h2></div>
</div>

<script>
const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vRqSPDvPhygiENSoBsVXQLMmy9kdwMNcFGYXZ7KSoLvGAVoLlFyUIKusstepG2Mz41o403RSl2a3c6G/pub?gid=1769609556&single=true&output=csv";

const EVENTS = ["é …ç›®ä¸€","é …ç›®äºŒ","é …ç›®ä¸‰","é …ç›®å››","é …ç›®äº”","é …ç›®å…­"];
const EVENT_REQUIRE = 6;
const REFRESH_INTERVAL = 30000;

const params = new URLSearchParams(location.search);
const isJudgeMode = params.get("judge") === "1";
if (isJudgeMode) document.body.classList.add("judge-mode");

document.getElementById("judgeToggle").textContent =
  isJudgeMode ? "â¬…ï¸ è¿”å›æ§åˆ¶å°" : "ğŸ‘©â€âš–ï¸ é€²å…¥è£åˆ¤æ¨¡å¼";

function toggleJudgeMode(){
  if (document.body.classList.contains("judge-mode")) params.delete("judge");
  else params.set("judge","1");
  location.search = params.toString();
}

let latest = {};

function loadData(){
  fetch(CSV_URL + "&_=" + Date.now())
    .then(r=>r.text())
    .then(parseCSV);
}

function parseCSV(csv){
  const rows = csv.trim().split("\n").slice(1).map(r=>r.split(","));
  const data = {};

  rows.forEach(r=>{
    const memberId = r[2];
    const action = r[3];
    if (!memberId || !action) return;

    const team = memberId.slice(0,2);
    const member = memberId.slice(2);

    data[team] ??= { first:new Set(), anyEvent:new Set(), anyone:new Set() };
    data[team].anyone.add(member);

    if (action === "é¦–æ¬¡å ±åˆ°") data[team].first.add(member);
    if (EVENTS.includes(action)) data[team].anyEvent.add(member);
  });

  latest = data;
  renderTeams();
  updateTime();
}

function renderTeams(){
  const root = document.getElementById("teamView");
  root.innerHTML = "<h2>ğŸ å°éšŠå³æ™‚ç‹€æ…‹</h2>";

  Object.keys(latest).sort().forEach(team=>{
    const firstCount = latest[team].first.size;
    const playedCount = latest[team].anyEvent.size;

    if (firstCount === 0 && playedCount === 0) return;

    const div = document.createElement("div");
    div.className = "team";

    /* âœ… å”¯ä¸€ç´…éšŠæ¢ä»¶ */
    if (firstCount > 0 && firstCount < EVENT_REQUIRE) {
      div.classList.add("team-alert");
    }

    div.innerHTML =
      `<div class="team-title">
        éšŠä¼ ${team}ï½œé¦–æ¬¡å ±åˆ° ${firstCount}ï½œå·²åƒè³½ ${playedCount}
      </div>`;

    [...latest[team].anyone].sort().forEach(m=>{
      let cls = "red";
      if (!latest[team].first.has(m) && latest[team].anyEvent.has(m)) cls="yellow";
      else if (latest[team].first.has(m) && latest[team].anyEvent.has(m)) cls="green";
      div.innerHTML += `<span class="member ${cls}">${m}</span>`;
    });

    root.appendChild(div);
  });
}

function updateTime(){
  const d = new Date();
  document.getElementById("lastUpdate").textContent =
    `æœ€å¾Œæ›´æ–°ï¼š${d.toLocaleTimeString("zh-HK",{hour12:false})}`;
}

loadData();
setInterval(loadData, REFRESH_INTERVAL);
</script>

</body>
</html>