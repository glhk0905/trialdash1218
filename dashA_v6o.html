<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<title>CC Shield å³æ™‚ç°½åˆ°ç³»çµ±</title>

<style>
body{margin:0;font-family:system-ui;background:#0f0f0f;color:#eee}
.topbar{display:flex;gap:10px;padding:10px;background:#111;border-bottom:1px solid #333}
button{background:#333;color:#fff;border:none;border-radius:6px;padding:8px 12px;font-size:15px;cursor:pointer}
button.active{background:#2ecc71;color:#000}
.spacer{flex:1}
.container{display:grid;grid-template-columns:3fr 1fr;gap:12px;padding:12px}
.panel{background:#1b1b1b;border-radius:12px;padding:12px;overflow:auto}
h2{margin:0 0 6px}

.group-title{margin-top:10px;font-weight:bold}

.team-line{
  background:#111;
  border-radius:6px;
  padding:6px 8px;
  margin:4px 0;
}
.ok{color:#2ecc71}
.warn{color:#f1c40f}
.bad{color:#ff6b6b}

.event-title{font-size:20px;margin:14px 0 6px;border-bottom:1px solid #333}
.team-row{background:#111;border-radius:6px;padding:6px 8px;margin:4px 0;cursor:pointer}
.team-row.pass{color:#2ecc71}
.team-row.fail{color:#ff6b6b}
.team-detail{font-size:14px;padding-left:12px;display:none}

#debug{display:none;background:#000;color:#0f0;padding:10px;font-size:13px}
</style>
</head>

<body>

<div class="topbar">
  <button id="normalBtn" class="active">ä¸€èˆ¬æ¨¡å¼</button>
  <button id="judgeBtn">è£åˆ¤æ¨¡å¼</button>
  <button id="debugBtn">Debug</button>
  <div class="spacer"></div>
  <div id="time"></div>
</div>

<div class="container">
  <div class="panel">
    <h2>ğŸ å°éšŠå³æ™‚ç‹€æ…‹</h2>
    <div id="teams"></div>
  </div>

  <div class="panel">
    <h2>ğŸ¯ æ¯”è³½é …ç›®</h2>
    <div id="eventPanel"></div>
  </div>
</div>

<pre id="debug"></pre>

<script>
const DATA_URL="https://docs.google.com/spreadsheets/d/1dwK703awpcqW6A3BofDA8cjNSlER2C2Tz5wIu7wr6XQ/gviz/tq?tqx=out:json";
const ITEM_ORDER=["é …ç›®ä¸€","é …ç›®äºŒ","é …ç›®ä¸‰","é …ç›®å››","é …ç›®äº”","é …ç›®å…­"];

let mode="normal";

const teamsEl=document.getElementById("teams");
const eventPanel=document.getElementById("eventPanel");
const debugEl=document.getElementById("debug");
const timeEl=document.getElementById("time");

normalBtn.onclick=()=>{mode="normal";normalBtn.classList.add("active");judgeBtn.classList.remove("active");update();}
judgeBtn.onclick=()=>{mode="judge";judgeBtn.classList.add("active");normalBtn.classList.remove("active");update();}
debugBtn.onclick=()=>debugEl.style.display=debugEl.style.display==="block"?"none":"block";

function norm(id){
 return id.replace(/[ï¼-ï¼™]/g,d=>String.fromCharCode(d.charCodeAt(0)-0xFEE0)).trim();
}

async function update(){
 const raw=await (await fetch(DATA_URL,{cache:"no-store"})).text();
 const json=JSON.parse(raw.substring(raw.indexOf("{"),raw.lastIndexOf("}")+1));
 const cols=json.table.cols.map(c=>c.label);
 const rows=json.table.rows.map(r=>{
  const o={};r.c.forEach((c,i)=>o[cols[i]]=c?.v??"");return o;
 });

 const checkin=new Set();
 const playTeams=new Set();
 const eventMap={};

 rows.forEach(r=>{
  const id=r["æˆå“¡ ID"],item=r["ç°½åˆ°é …ç›®"];
  if(!id||!item) return;
  const m=norm(id).match(/^(\d+)[A-Z]$/);
  if(!m) return;
  const team=m[1].padStart(2,"0");

  if(item==="é¦–æ¬¡å ±åˆ°") checkin.add(team);
  else{
    playTeams.add(team);
    eventMap[item]??={};
    eventMap[item][team]??=0;
    eventMap[item][team]++;
  }
 });

 // ===== å°éšŠå³æ™‚ç‹€æ…‹ï¼ˆdashA_v6k è¡Œç‚ºï¼‰=====
 teamsEl.innerHTML="";
 const allTeams=[...new Set([...checkin,...playTeams])].sort();

 const group=(title,cls,filter)=>{
  const list=allTeams.filter(filter);
  if(mode==="judge" && cls==="ok") return;
  if(list.length===0) return;
  teamsEl.innerHTML+=`<div class="group-title ${cls}">${title}</div>`;
  list.forEach(t=>{
    teamsEl.innerHTML+=`<div class="team-line ${cls}">éšŠä¼ ${t}</div>`;
  });
 };

 group("âœ… å·²å ±åˆ°ï¼‹å·²åƒè³½","ok",t=>checkin.has(t)&&playTeams.has(t));
 group("ğŸŸ¡ å·²å ±åˆ°æœªåƒè³½","warn",t=>checkin.has(t)&&!playTeams.has(t));
 group("âŒ æœªå ±åˆ°ä½†å·²åƒè³½","bad",t=>!checkin.has(t)&&playTeams.has(t));

 // ===== æ¯”è³½é …ç›®ï¼ˆåŸæœ‰è¡Œç‚ºï¼‰=====
 eventPanel.innerHTML="";
 ITEM_ORDER.filter(i=>eventMap[i]).forEach(item=>{
  eventPanel.innerHTML+=`<div class="event-title">${item}</div>`;
  Object.keys(eventMap[item]).sort().forEach(t=>{
    if(mode==="judge" && eventMap[item][t]>=6) return;
    const row=document.createElement("div");
    row.className="team-row "+(eventMap[item][t]>=6?"pass":"fail");
    row.textContent=`${eventMap[item][t]>=6?"âœ…":"âŒ"} éšŠä¼ ${t} (${eventMap[item][t]}/6)`;
    eventPanel.appendChild(row);
  });
 });

 debugEl.textContent=JSON.stringify(rows.slice(-5),null,2);
 timeEl.textContent="æœ€å¾Œæ›´æ–°ï¼š"+new Date().toLocaleTimeString("zh-HK");
}

update();
setInterval(update,20000);
</script>

</body>
</html>