<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<title>CC Shield å³æ™‚ç°½åˆ°ç³»çµ±</title>

<style>
body{margin:0;font-family:system-ui;background:#0f0f0f;color:#eee}
.topbar{display:flex;gap:10px;padding:10px;background:#111;border-bottom:1px solid #333}
button{background:#333;color:#fff;border:none;border-radius:6px;padding:8px 12px;font-size:15px;cursor:pointer}
button.active{background:#2ecc71;color:#000}
.spacer{flex:1}
.container{display:grid;grid-template-columns:3fr 1fr;gap:12px;padding:12px}
.panel{background:#1b1b1b;border-radius:12px;padding:12px;overflow:auto}
h2{margin:0 0 6px}

.team-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}

.team-card{
  background:#141414;
  border:2px solid #333;
  border-radius:10px;
  padding:10px;
}
.team-card.bad{border-color:#ff5c5c}
.team-title{font-weight:bold;margin-bottom:6px}

.member{
 display:inline-block;
 width:26px;height:26px;
 line-height:26px;
 text-align:center;
 border-radius:6px;
 margin:2px;
 font-weight:bold;
 font-size:13px;
}
.m-ok{background:#2ecc71;color:#000}
.m-warn{background:#f1c40f;color:#000}
.m-bad{background:#e74c3c;color:#fff}

.event-title{font-size:18px;margin:14px 0 6px;border-bottom:1px solid #333}
.team-row{background:#111;border-radius:6px;padding:6px 8px;margin:4px 0}
.team-row.pass{color:#2ecc71}
.team-row.fail{color:#ff6b6b}

#debug{display:none;background:#000;color:#0f0;padding:10px;font-size:13px}
</style>
</head>

<body>

<div class="topbar">
  <button id="normalBtn" class="active">ä¸€èˆ¬æ¨¡å¼</button>
  <button id="judgeBtn">è£åˆ¤æ¨¡å¼</button>
  <button id="debugBtn">Debug</button>
  <div class="spacer"></div>
  <div id="time"></div>
</div>

<div class="container">
  <div class="panel">
    <h2>ğŸ å°éšŠå³æ™‚ç‹€æ…‹</h2>
    <div id="teams" class="team-grid"></div>
  </div>

  <div class="panel">
    <h2>ğŸ¯ æ¯”è³½é …ç›®</h2>
    <div id="eventPanel"></div>
  </div>
</div>

<pre id="debug"></pre>

<script>
const DATA_URL="https://docs.google.com/spreadsheets/d/1dwK703awpcqW6A3BofDA8cjNSlER2C2Tz5wIu7wr6XQ/gviz/tq?tqx=out:json";
const MEMBERS=["A","B","C","D","E","F","G","H"];
let mode="normal";

normalBtn.onclick=()=>{mode="normal";normalBtn.classList.add("active");judgeBtn.classList.remove("active");update();}
judgeBtn.onclick=()=>{mode="judge";judgeBtn.classList.add("active");normalBtn.classList.remove("active");update();}
debugBtn.onclick=()=>debugEl.style.display=debugEl.style.display==="block"?"none":"block";

function norm(id){
 return id.replace(/[ï¼-ï¼™]/g,d=>String.fromCharCode(d.charCodeAt(0)-0xFEE0)).trim();
}

async function update(){
 const raw=await (await fetch(DATA_URL,{cache:"no-store"})).text();
 const json=JSON.parse(raw.substring(raw.indexOf("{"),raw.lastIndexOf("}")+1));
 const cols=json.table.cols.map(c=>c.label);
 const rows=json.table.rows.map(r=>{
  const o={};r.c.forEach((c,i)=>o[cols[i]]=c?.v??"");return o;
 });

 const teams={};

 rows.forEach(r=>{
  const id=r["æˆå“¡ ID"],item=r["ç°½åˆ°é …ç›®"];
  if(!id||!item) return;
  const m=norm(id).match(/^(\d+)([A-Z])$/);
  if(!m) return;
  const t=m[1].padStart(2,"0"),mem=m[2];
  teams[t]??={check:new Set(),play:new Set()};
  if(item==="é¦–æ¬¡å ±åˆ°") teams[t].check.add(mem);
  else teams[t].play.add(mem);
 });

 const el=document.getElementById("teams");
 el.innerHTML="";

 Object.keys(teams).sort().forEach(t=>{
  const data=teams[t];
  const checkCnt=data.check.size;
  const playCnt=data.play.size;
  const abnormal = playCnt>0 && checkCnt===0 || checkCnt>0 && playCnt===0;

  if(mode==="judge" && !abnormal) return;

  const card=document.createElement("div");
  card.className="team-card"+(abnormal?" bad":"");

  card.innerHTML=`<div class="team-title">éšŠä¼ ${t} ï½œ å‡ºå¸­ ${checkCnt} ï½œ å·²åƒè³½ ${playCnt}</div>`;

  MEMBERS.forEach(m=>{
    let cls="m-ok";
    if(data.play.has(m)&&!data.check.has(m)) cls="m-bad";
    else if(data.check.has(m)&&!data.play.has(m)) cls="m-warn";
    card.innerHTML+=`<span class="member ${cls}">${m}</span>`;
  });

  el.appendChild(card);
 });

 debugEl.textContent=JSON.stringify(rows.slice(-5),null,2);
 timeEl.textContent="æœ€å¾Œæ›´æ–°ï¼š"+new Date().toLocaleTimeString("zh-HK");
}

update();
setInterval(update,20000);
</script>

</body>
</html>