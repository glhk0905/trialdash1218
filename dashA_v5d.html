<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<title>å³æ™‚ç°½åˆ°ç³»çµ±</title>
<style>
body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:#0f0f0f;
  color:#eee
}
.topbar{
  display:flex;
  gap:10px;
  padding:10px;
  background:#111;
  border-bottom:1px solid #333
}
button{
  background:#333;
  color:#fff;
  border:none;
  border-radius:6px;
  padding:8px 12px;
  font-size:15px;
  cursor:pointer
}
button.active{
  background:#2ecc71;
  color:#000
}
.spacer{flex:1}

.container{
  display:grid;
  grid-template-columns:3fr 1fr;
  gap:12px;
  padding:12px
}
.panel{
  background:#1b1b1b;
  border-radius:12px;
  padding:12px;
  overflow:auto
}
h2{margin:0 0 6px}

/* ===== Legend ===== */
.legend{
  display:flex;
  gap:16px;
  font-size:14px;
  opacity:.9;
  margin-bottom:10px;
  flex-wrap:wrap
}
.legend span{
  display:flex;
  align-items:center;
  gap:6px
}
.legend .dot{
  width:14px;
  height:14px;
  border-radius:4px
}
.legend .green{background:#2ecc71}
.legend .red{background:#e74c3c}
.legend .orange{background:#f39c12}

/* ===== å°éšŠ ===== */
#teams{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px
}
.team{
  border:2px solid #333;
  border-radius:12px;
  padding:10px
}
.team.alert{
  border-color:#e74c3c;
  background:#2a1212
}
.team-header{
  font-size:17px;
  font-weight:bold;
  margin-bottom:6px;
  display:flex;
  gap:8px;
  flex-wrap:wrap
}

/* ===== æˆå“¡ ===== */
.member{
  display:inline-block;
  margin:4px;
  padding:6px 10px;
  border-radius:8px;
  font-weight:bold
}
.green{background:#2ecc71;color:#000}
.red{background:#e74c3c;color:#000}
.orange{background:#f39c12;color:#000}

/* ===== æ¯”è³½é …ç›® ===== */
.event-team{
  cursor:pointer;
  padding:6px 0;
  border-bottom:1px solid #333
}
.event-detail{
  padding-left:14px;
  font-size:14px;
  display:none
}

/* ===== Debug ===== */
#debug{
  display:none;
  margin:12px;
  background:#000;
  color:#0f0;
  padding:10px;
  font-size:13px;
  white-space:pre-wrap
}
</style>
</head>
<body>

<div class="topbar">
  <button id="normalBtn" class="active">ä¸€èˆ¬æ¨¡å¼</button>
  <button id="judgeBtn">è£åˆ¤æ¨¡å¼</button>
  <button id="debugBtn">Debug</button>
  <div class="spacer"></div>
  <div id="time"></div>
</div>

<div class="container">
  <div class="panel" id="teamPanel">
    <h2>ğŸ å°éšŠå³æ™‚ç‹€æ…‹</h2>

    <!-- âœ… é¡è‰²è¨»è§£ -->
    <div class="legend">
      <span><i class="dot green"></i> å·²å ±åˆ°ï¼‹å·²åƒè³½</span>
      <span><i class="dot red"></i> å·²å ±åˆ°æœªåƒè³½</span>
      <span><i class="dot orange"></i> æœªå ±åˆ°ä½†å·²åƒè³½</span>
    </div>

    <div id="teams"></div>
  </div>

  <div class="panel" id="eventPanel">
    <h2>ğŸ¯ æ¯”è³½é …ç›®</h2>
    <div id="events"></div>
  </div>
</div>

<pre id="debug"></pre>

<script>
const CSV_URL="YOUR_CSV_URL_HERE";
let showDebug=false;

debugBtn.onclick=()=>{
  showDebug=!showDebug;
  debug.style.display=showDebug?"block":"none";
};

function parseCSV(t){
  const l=t.trim().split(/\r?\n/);
  const h=l[0].split(",");
  return l.slice(1).map(r=>{
    const c=r.split(",");
    const o={};
    h.forEach((x,i)=>o[x]=c[i]);
    return o;
  });
}

async function update(){
  const res=await fetch(CSV_URL,{cache:"no-store"});
  const text=await res.text();
  const rows=parseCSV(text);

  const teamsData={}, eventsData={};

  rows.forEach(r=>{
    const id=r["æˆå“¡ ID"];
    const item=r["ç°½åˆ°é …ç›®"];
    if(!id||!item)return;

    const team=id.slice(0,2);
    const m=id.slice(2);

    teamsData[team]??={members:new Set(),checkin:new Set(),event:new Set()};
    teamsData[team].members.add(m);

    if(item==="é¦–æ¬¡å ±åˆ°"){
      teamsData[team].checkin.add(m);
    }else{
      teamsData[team].event.add(m);
      eventsData[item]??={};
      eventsData[item][team]??=new Set();
      eventsData[item][team].add(m);
    }
  });

  /* ===== å°éšŠ ===== */
  teams.innerHTML="";
  Object.keys(teamsData).sort().forEach(t=>{
    const d=teamsData[t];
    const total=d.members.size;
    const alert=total<6;

    const box=document.createElement("div");
    box.className="team"+(alert?" alert":"");
    box.innerHTML=`
      <div class="team-header">
        éšŠä¼ ${t} ï½œ å‡ºå¸­ï¼š${d.checkin.size} ï½œ å·²åƒè³½ï¼š${d.event.size}
      </div>
    `;

    [...d.members].sort().forEach(m=>{
      let cls="";
      if(d.checkin.has(m)&&d.event.has(m)) cls="green";
      else if(d.checkin.has(m)) cls="red";
      else if(d.event.has(m)) cls="orange";
      else return;
      box.innerHTML+=`<span class="member ${cls}">${m}</span>`;
    });

    teams.appendChild(box);
  });

  /* ===== æ¯”è³½é …ç›® ===== */
  events.innerHTML="";
  Object.keys(eventsData).forEach(ev=>{
    events.innerHTML+=`<b>${ev}</b><br>`;
    Object.keys(eventsData[ev]).forEach(t=>{
      const line=document.createElement("div");
      line.className="event-team";
      line.textContent=`â–¶ éšŠä¼ ${t} (${eventsData[ev][t].size}/6)`;

      const det=document.createElement("div");
      det.className="event-detail";
      det.textContent=[...eventsData[ev][t]].join(" ");

      line.onclick=()=>{
        det.style.display = det.style.display ? "" : "block";
      };

      events.append(line,det);
    });
  });

  /* ===== Debug ===== */
  debug.textContent = rows.slice(-5).map(r =>
    `${r["æ™‚é–“"]||""} | ${r["æˆå“¡ ID"]} | ${r["ç°½åˆ°é …ç›®"]}`
  ).join("\n");

  time.textContent="æœ€å¾Œæ›´æ–°ï¼š"+new Date().toLocaleTimeString("zh-HK");
}

update();
setInterval(update,20000);
</script>

</body>
</html>