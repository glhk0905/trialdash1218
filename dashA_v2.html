<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ¯”è³½å³æ™‚ç›£æ§ Dashboard</title>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system;
  background: #0f0f0f;
  color: #f0f0f0;
}

/* å³ä¸Šè§’ */
#topRight {
  position: fixed;
  top: 12px;
  right: 12px;
  z-index: 1000;
  display: flex;
  gap: 10px;
  align-items: center;
}
#judgeToggle {
  background: #3498db;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
}
.judge-mode #judgeToggle { background:#555; }
#lastUpdate {
  font-size: 14px;
  color: #ccc;
}

.container {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 12px;
  padding: 12px;
  height: 100vh;
}
.card {
  background: #1a1a1a;
  border-radius: 10px;
  padding: 12px;
  overflow-y: auto;
}
.judge-mode .container { grid-template-columns: 1fr; }
.judge-mode #teamView { display:none; }

h2 { font-size: 26px; margin: 6px 0 12px; }

/* æˆå“¡ */
.member {
  display:inline-block;
  min-width:46px;
  margin:4px;
  padding:6px 0;
  text-align:center;
  font-weight:700;
  border-radius:6px;
  color:#000;
}
.green { background:#2ecc71; }
.red { background:#e74c3c; }

/* å·¦é‚Š */
.team {
  border-bottom:1px solid #333;
  padding:8px 0;
}
.team-title {
  font-size:22px;
  font-weight:700;
}

/* å³é‚Š */
.event { margin-bottom:18px; }
.event strong {
  font-size:22px;
  display:block;
  margin-bottom:6px;
}
.event-line {
  font-size:22px;
  font-weight:700;
  margin:8px 0;
  cursor:pointer;
}
.event-line.incomplete span { color:#ff4d4d; }

/* Modal */
.modal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.8);
  display:none;
  align-items:center;
  justify-content:center;
}
.modal-content {
  background:#1a1a1a;
  width:90%;
  max-width:600px;
  border-radius:10px;
  padding:16px;
}
#modalTitle { font-size:24px; margin-bottom:12px; }
.close-btn {
  float:right;
  font-size:22px;
  cursor:pointer;
}
.list-title {
  font-size:20px;
  margin:12px 0 6px;
}
</style>
</head>

<body>

<div id="topRight">
  <button id="judgeToggle" onclick="toggleJudgeMode()">ğŸ‘©â€âš–ï¸ é€²å…¥è£åˆ¤æ¨¡å¼</button>
  <div id="lastUpdate">â€”</div>
</div>

<div class="container">
  <div class="card" id="teamView"><h2>ğŸ å°éšŠå³æ™‚ç‹€æ…‹</h2></div>
  <div class="card" id="eventView"><h2>ğŸ¯ æ¯”è³½é …ç›®</h2></div>
</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal()">âœ–</span>
    <div id="modalTitle"></div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vRqSPDvPhygiENSoBsVXQLMmy9kdwMNcFGYXZ7KSoLvGAVoLlFyUIKusstepG2Mz41o403RSl2a3c6G/pub?gid=1769609556&single=true&output=csv";

const EVENTS = ["é …ç›®ä¸€","é …ç›®äºŒ","é …ç›®ä¸‰","é …ç›®å››","é …ç›®äº”","é …ç›®å…­"];
const EVENT_REQUIRE = 6;
const REFRESH_INTERVAL = 30000;

/* æ¨¡å¼ */
const params = new URLSearchParams(location.search);
const isJudgeMode = params.get("judge") === "1";
if (isJudgeMode) document.body.classList.add("judge-mode");
document.getElementById("judgeToggle").textContent =
  isJudgeMode ? "â¬…ï¸ è¿”å›æ§åˆ¶å°" : "ğŸ‘©â€âš–ï¸ é€²å…¥è£åˆ¤æ¨¡å¼";

function toggleJudgeMode(){
  if (document.body.classList.contains("judge-mode")) {
    params.delete("judge");
  } else {
    params.set("judge","1");
  }
  location.search = params.toString();
}

let latest = {};

function loadData(){
  fetch(CSV_URL + "&_=" + Date.now())
    .then(r=>r.text())
    .then(parseCSV);
}

function parseCSV(csv){
  const rows = csv.trim().split("\n").slice(1).map(r=>r.split(","));
  const data = {};

  rows.forEach(r=>{
    const memberId = r[2];
    const action = r[3];
    if (!memberId || !action) return;

    const team = memberId.slice(0,2);
    const member = memberId.slice(2);

    data[team] ??= { first:new Set(), anyEvent:new Set(), events:{} };

    if (action === "é¦–æ¬¡å ±åˆ°") data[team].first.add(member);

    if (EVENTS.includes(action)) {
      data[team].anyEvent.add(member);
      data[team].events[action] ??= new Set();
      data[team].events[action].add(member);
    }
  });

  latest = data;
  renderTeams();
  renderEvents();
  updateTime();
}

/* å·¦é‚Š */
function renderTeams(){
  const root = document.getElementById("teamView");
  root.innerHTML = "<h2>ğŸ å°éšŠå³æ™‚ç‹€æ…‹</h2>";

  Object.keys(latest).sort().forEach(team=>{
    const members = [...latest[team].first].sort();
    if (!members.length) return;

    const div = document.createElement("div");
    div.className = "team";
    div.innerHTML = `<div class="team-title">éšŠä¼ ${team}ï½œ${members.length} äºº</div>`;

    members.forEach(m=>{
      const cls = latest[team].anyEvent.has(m) ? "green" : "red";
      div.innerHTML += `<span class="member ${cls}">${m}</span>`;
    });
    root.appendChild(div);
  });
}

/* âœ… å³é‚Šï¼šé …ç›®å…§å°éšŠæ’åº */
function renderEvents(){
  const root = document.getElementById("eventView");
  root.innerHTML = "<h2>ğŸ¯ æ¯”è³½é …ç›®</h2>";

  EVENTS.forEach(ev=>{
    const teams = [];

    Object.keys(latest).sort().forEach(team=>{
      const p = latest[team].events[ev];
      if (p && p.size>0) {
        teams.push({
          team,
          present:[...p],
          all:[...latest[team].first]
        });
      }
    });

    if (!teams.length) return;

    const div = document.createElement("div");
    div.className = "event";
    div.innerHTML = `<strong>${ev}</strong>`;

    teams.forEach(t=>{
      const line = document.createElement("div");
      line.className = "event-line";

      if (t.present.length >= EVENT_REQUIRE) {
        line.textContent = `éšŠä¼ ${t.team} âœ…`;
      } else {
        line.classList.add("incomplete");
        line.innerHTML = `éšŠä¼ ${t.team} <span>${t.present.length}/${EVENT_REQUIRE}</span>`;
        line.onclick = ()=>showMissing(ev,t);
      }
      div.appendChild(line);
    });

    root.appendChild(div);
  });
}

/* Modal */
function showMissing(ev,t){
  document.getElementById("modal").style.display="flex";
  document.getElementById("modalTitle").textContent = `${ev}ï½œéšŠä¼ ${t.team}`;

  const absent = t.all.filter(m=>!t.present.includes(m)).sort();

  document.getElementById("modalBody").innerHTML = `
    <div class="list-title">âœ… å·²å ±åˆ°</div>
    ${t.present.sort().map(m=>`<span class="member green">${m}</span>`).join("")}
    <div class="list-title">âŒ æœªå ±åˆ°</div>
    ${absent.map(m=>`<span class="member red">${m}</span>`).join("")}
  `;
}
function closeModal(){ document.getElementById("modal").style.display="none"; }

/* æ›´æ–°æ™‚é–“ */
function updateTime(){
  const d = new Date();
  document.getElementById("lastUpdate").textContent =
    `æœ€å¾Œæ›´æ–°ï¼š${d.toLocaleTimeString("zh-HK",{hour12:false})}`;
}

loadData();
setInterval(loadData, REFRESH_INTERVAL);
</script>

</body>
</html>