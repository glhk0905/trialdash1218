<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<title>CC Shield å³æ™‚ç°½åˆ°ç‹€æ…‹</title>
<style>
body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:#0f0f0f;
  color:#eee;
}
.topbar{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 14px;
  background:#111;
  border-bottom:1px solid #333;
}
button{
  font-size:15px;
  background:#333;
  color:#fff;
  border:none;
  border-radius:6px;
  padding:8px 12px;
  cursor:pointer;
}
button.active{background:#2ecc71;color:#000;}
.spacer{flex:1}
.time{font-size:15px;opacity:.85}

.container{
  display:grid;
  grid-template-columns:3fr 1fr;
  gap:14px;
  padding:14px;
}
.panel{
  background:#1b1b1b;
  border-radius:12px;
  padding:14px;
  overflow-y:auto;
  max-height:calc(100vh - 80px);
}
h2{margin:0 0 10px;font-size:22px}

/* ===== å°éšŠ ===== */
.team{
  border:2px solid #333;
  border-radius:12px;
  padding:10px;
  margin-bottom:12px;
}
.team.alert{
  border-color:#e74c3c;
  background:#2a1212;
}

/* æ¨™é¡Œåˆ—ï¼ˆéšŠä¼ï¼‹äººæ•¸ï¼‰ */
.team-header{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:18px;
  font-weight:bold;
  margin-bottom:6px;
}
.team-header span{
  font-weight:normal;
  opacity:.9;
}

/* ===== æˆå“¡ ===== */
.member{
  display:inline-block;
  padding:6px 10px;
  margin:4px;
  border-radius:8px;
  font-size:16px;
  font-weight:bold;
}
.green{background:#2ecc71;color:#000}
.red{background:#e74c3c;color:#000}
.orange{background:#f39c12;color:#000}

/* ===== Debug ===== */
#debug{
  white-space:pre-wrap;
  font-size:14px;
  background:#000;
  color:#0f0;
  padding:12px;
  margin:14px;
  border-radius:8px;
  display:none;
}
</style>
</head>
<body>

<div class="topbar">
  <button id="normalBtn">ä¸€èˆ¬æ¨¡å¼</button>
  <button id="judgeBtn">è£åˆ¤æ¨¡å¼</button>
  <button id="debugBtn">Debug</button>
  <div class="spacer"></div>
  <div class="time" id="updateTime">æœ€å¾Œæ›´æ–°ï¼š--:--:--</div>
</div>

<div class="container" id="layout">
  <div class="panel" id="teamView">
    <h2>ğŸ å°éšŠå³æ™‚ç‹€æ…‹</h2>
    <div id="teams"></div>
  </div>
  <div class="panel" id="eventView">
    <h2>ğŸ¯ æ¯”è³½é …ç›®</h2>
    <div id="events"></div>
  </div>
</div>

<pre id="debug"></pre>

<script>
const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vRqSPDvPhygiENSoBsVXQLMmy9kdwMNcFGYXZ7KSoLvGAVoLlFyUIKusstepG2Mz41o403RSl2a3c6G/pub?output=csv";

const REFRESH_MS = 20000;

let isJudge=false, showDebug=false;

const normalBtn=document.getElementById("normalBtn");
const judgeBtn=document.getElementById("judgeBtn");
const debugBtn=document.getElementById("debugBtn");
const debugBox=document.getElementById("debug");
const teamView=document.getElementById("teamView");
const layout=document.getElementById("layout");
const updateTime=document.getElementById("updateTime");

function updateMode(){
  normalBtn.classList.toggle("active",!isJudge);
  judgeBtn.classList.toggle("active",isJudge);
  teamView.style.display=isJudge?"none":"block";
  layout.style.gridTemplateColumns=isJudge?"1fr":"3fr 1fr";
}
normalBtn.onclick=()=>{isJudge=false;updateMode()};
judgeBtn.onclick=()=>{isJudge=true;updateMode()};
debugBtn.onclick=()=>{
  showDebug=!showDebug;
  debugBox.style.display=showDebug?"block":"none";
};
updateMode();

function parseCSV(text){
  const lines=text.trim().split(/\r?\n/);
  const headers=lines[0].split(",");
  return lines.slice(1).map(line=>{
    const cols=line.split(",");
    const o={};
    headers.forEach((h,i)=>o[h.trim()]=(cols[i]||"").trim());
    return o;
  });
}

async function update(){
  const res=await fetch(CSV_URL,{cache:"no-store"});
  const text=await res.text();
  const rows=parseCSV(text);

  teams.innerHTML="";

  const data={};

  rows.forEach(r=>{
    const raw=r["æˆå“¡ ID"];
    const item=r["ç°½åˆ°é …ç›®"];
    if(!raw||raw.length<3||!item)return;

    const team=raw.slice(0,2);
    const member=raw.slice(2);

    data[team]??={members:new Set(),checkin:new Set(),events:new Set()};
    data[team].members.add(member);

    if(item==="é¦–æ¬¡å ±åˆ°"){
      data[team].checkin.add(member);
    }else{
      data[team].events.add(member);
    }
  });

  Object.keys(data).sort().forEach(team=>{
    const t=data[team];
    const checkinCount=t.checkin.size;
    const eventCount=t.events.size;
    const alert=checkinCount>0 && checkinCount<6;

    const div=document.createElement("div");
    div.className="team"+(alert?" alert":"");

    div.innerHTML=`
      <div class="team-header">
        <div>éšŠä¼ ${team}</div>
        <span>ï½œ å‡ºå¸­ï¼š${checkinCount}</span>
        <span>ï½œ å·²åƒè³½ï¼š${eventCount}</span>
      </div>
    `;

    [...t.members].sort().forEach(m=>{
      const hasCheckin=t.checkin.has(m);
      const hasEvent=t.events.has(m);

      let cls="";
      if(hasCheckin && hasEvent) cls="green";
      else if(hasCheckin && !hasEvent) cls="red";
      else if(!hasCheckin && hasEvent) cls="orange";
      else return;

      div.innerHTML+=`<span class="member ${cls}">${m}</span>`;
    });

    teams.appendChild(div);
  });

  updateTime.textContent =
    "æœ€å¾Œæ›´æ–°ï¼š" + new Date().toLocaleTimeString("zh-HK");
}

update();
setInterval(update,REFRESH_MS);
</script>

</body>
</html>