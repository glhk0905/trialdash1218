<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<title>CC Shield å³æ™‚ç°½åˆ°ç³»çµ±</title>

<style>
body{margin:0;font-family:system-ui;background:#0f0f0f;color:#eee}
.topbar{display:flex;gap:10px;padding:12px;background:#111;border-bottom:1px solid #333;align-items:center}
button{background:#333;color:#fff;border:none;border-radius:6px;padding:8px 14px;font-size:16px;cursor:pointer}
input{background:#000;color:#0f0;border:1px solid #333;border-radius:6px;padding:8px;font-size:14px;width:420px}
.spacer{flex:1}
#time{font-size:18px;font-weight:bold}

.container{display:grid;grid-template-columns:3fr 1fr;gap:14px;padding:14px}
.panel{background:#1b1b1b;border-radius:14px;padding:14px}

h2{margin:0 0 8px;font-size:22px}

.legend{font-size:16px;margin-bottom:10px}
.legend span{margin-right:16px}

.team-grid{
 display:grid;
 grid-template-columns:repeat(3,1fr);
 gap:12px
}

.team-card{
 background:#141414;
 border:2px solid #333;
 border-radius:12px;
 padding:12px;
 font-size:18px;
}
.team-card.bad{
 border-color:#ff5c5c;
 background:#2a0f0f;
}

.team-title{font-weight:bold;margin-bottom:8px}

.member{
 display:inline-block;
 width:30px;height:30px;
 line-height:30px;
 text-align:center;
 border-radius:6px;
 margin:3px;
 font-weight:bold;
}
.m-ok{background:#2ecc71;color:#000}
.m-warn{background:#f1c40f;color:#000}
.m-bad{background:#e74c3c;color:#fff}

/* ===== æ¯”è³½é …ç›® ===== */
.event-title{font-size:20px;margin:14px 0 6px;border-bottom:1px solid #333}

.event-team{
 background:#111;
 border-radius:8px;
 padding:8px 10px;
 margin:6px 0;
 cursor:pointer;
}
.event-team.pass{color:#2ecc71}
.event-team.fail{color:#ff6b6b}

.event-detail{
 display:none;
 font-size:14px;
 margin-top:6px;
 padding-left:10px;
}

.notice{
 color:#f1c40f;
 font-size:14px;
 margin-top:6px;
}

#debug{display:none;background:#000;color:#0f0;padding:10px;font-size:13px}
</style>
</head>

<body>

<div class="topbar">
  <strong>Google Sheetï¼š</strong>
  <input id="sheetInput" placeholder="è²¼ä¸Š Google Sheet å®Œæ•´ç¶²å€ç„¶å¾ŒæŒ‰ Enter">
  <button id="applyBtn">å¥—ç”¨</button>
  <div class="spacer"></div>
  <div id="time">ç­‰å¾…è³‡æ–™â€¦</div>
</div>

<div class="container">
  <div class="panel">
    <h2>ğŸ å°éšŠå³æ™‚ç‹€æ…‹</h2>
    <div class="legend">
      <span>ğŸŸ¢ å·²å ±åˆ°ï¼‹å·²åƒè³½</span>
      <span>ğŸŸ¡ å·²å ±åˆ°æœªåƒè³½</span>
      <span>ğŸ”´ æœªå ±åˆ°ä½†å·²åƒè³½</span>
    </div>
    <div id="teams" class="team-grid"></div>
  </div>

  <div class="panel">
    <h2>ğŸ¯ æ¯”è³½é …ç›®</h2>
    <div id="eventPanel"></div>
    <div id="status" class="notice"></div>
  </div>
</div>

<pre id="debug"></pre>

<script>
/* ========= LOCKED CORE LOGIC =========
Only change: dynamic spreadsheet URL input
==================================== */

let DATA_URL = "";
let lastGoodJson = null;

const teamsEl=document.getElementById("teams");
const eventPanel=document.getElementById("eventPanel");
const timeEl=document.getElementById("time");
const statusEl=document.getElementById("status");
const sheetInput=document.getElementById("sheetInput");

document.getElementById("applyBtn").onclick=applySheet;
sheetInput.onkeydown=e=>e.key==="Enter"&&applySheet();

function extractId(url){
 const m=url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
 return m?m[1]:null;
}

function applySheet(){
 const id=extractId(sheetInput.value.trim());
 if(!id){
   alert("æœªèƒ½è­˜åˆ¥ Google Sheet ç¶²å€");
   return;
 }
 DATA_URL=`https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json&headers=1`;
 update(true);
}

function norm(id){
 return id.replace(/[ï¼-ï¼™]/g,d=>String.fromCharCode(d.charCodeAt(0)-0xFEE0)).trim();
}

async function fetchData(){
 try{
  const res=await fetch(DATA_URL,{cache:"no-store"});
  const text=await res.text();
  if(!text.startsWith("{")) throw "Not JSON";
  const json=JSON.parse(text.substring(text.indexOf("{"),text.lastIndexOf("}")+1));
  lastGoodJson=json;
  statusEl.textContent="";
  return json;
 }catch{
  statusEl.textContent="âš ï¸ è³‡æ–™åŒæ­¥ä¸­ï¼Œé¡¯ç¤ºä¸Šä¸€ç­†è³‡æ–™";
  return lastGoodJson;
 }
}

function render(json){
 if(!json) return;

 const cols=json.table.cols.map(c=>c.label);
 const rows=json.table.rows.map(r=>{
  const o={}; r.c.forEach((c,i)=>o[cols[i]]=c?.v??""); return o;
 });

 const teams={}, events={};

 rows.forEach(r=>{
  const id=r["æˆå“¡ ID"], item=r["ç°½åˆ°é …ç›®"];
  if(!id||!item) return;
  const m=norm(id).match(/^(\d+)([A-Z])$/);
  if(!m) return;
  const t=m[1].padStart(2,"0"), mem=m[2];

  teams[t]??={check:new Set(), play:new Set(), all:new Set()};
  teams[t].all.add(mem);

  if(item==="é¦–æ¬¡å ±åˆ°") teams[t].check.add(mem);
  else{
    teams[t].play.add(mem);
    events[item]??={};
    events[item][t]??={play:new Set()};
    events[item][t].play.add(mem);
  }
 });

 teamsEl.innerHTML="";
 Object.keys(teams).sort().forEach(t=>{
  const d=teams[t];
  const card=document.createElement("div");
  card.className="team-card"+(d.check.size<6?" bad":"");
  card.innerHTML=`<div class="team-title">éšŠä¼ ${t} ï½œ å‡ºå¸­ ${d.check.size} ï½œ å·²åƒè³½ ${d.play.size}</div>`;
  [...d.all].sort().forEach(m=>{
    let cls="m-ok";
    if(d.play.has(m)&&!d.check.has(m)) cls="m-bad";
    else if(d.check.has(m)&&!d.play.has(m)) cls="m-warn";
    card.innerHTML+=`<span class="member ${cls}">${m}</span>`;
  });
  teamsEl.appendChild(card);
 });

 eventPanel.innerHTML="";
 Object.keys(events).forEach(item=>{
  eventPanel.innerHTML+=`<div class="event-title">${item}</div>`;
  Object.keys(events[item]).sort().forEach(t=>{
    const play=[...events[item][t].play].sort();
    const check=[...teams[t].check].filter(m=>!events[item][t].play.has(m)).sort();

    const row=document.createElement("div");
    row.className="event-team "+(play.length>=6?"pass":"fail");
    row.textContent=`éšŠä¼ ${t} (${play.length}/6)`;

    const detail=document.createElement("div");
    detail.className="event-detail";
    detail.innerHTML=`âœ… å·²ç°½åˆ°ï¼š${play.join(" ")||"-"}<br>ğŸŸ¡ æœªç°½åˆ°ï¼š${check.join(" ")||"-"}`;

    row.onclick=()=>detail.style.display=
      detail.style.display==="block"?"none":"block";

    eventPanel.appendChild(row);
    eventPanel.appendChild(detail);
  });
 });

 timeEl.textContent="æœ€å¾Œæ›´æ–°ï¼š" + new Date().toLocaleTimeString("zh-HK");
}

async function update(force=false){
 if(!DATA_URL && !force) return;
 const json=await fetchData();
 render(json);
}

setInterval(update,20000);
</script>

</body>
</html>