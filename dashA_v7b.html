<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<title>CC Shield å³æ™‚ç°½åˆ°ç³»çµ±</title>

<style>
body{margin:0;font-family:system-ui;background:#0f0f0f;color:#eee}
.topbar{display:flex;gap:10px;padding:12px;background:#111;border-bottom:1px solid #333}
button{background:#333;color:#fff;border:none;border-radius:6px;padding:8px 14px;font-size:16px}
.spacer{flex:1}
#time{font-size:18px;font-weight:bold}

.container{display:grid;grid-template-columns:3fr 1fr;gap:14px;padding:14px}
.panel{background:#1b1b1b;border-radius:14px;padding:14px}

h2{margin:0 0 8px;font-size:22px}

.legend{font-size:16px;margin-bottom:10px}
.legend span{margin-right:16px}

.team-grid{
 display:grid;
 grid-template-columns:repeat(3,1fr);
 gap:12px
}

.team-card{
 background:#141414;
 border:2px solid #333;
 border-radius:12px;
 padding:12px;
 font-size:18px;
}
.team-card.bad{
 border-color:#ff5c5c;
 background:#2a0f0f;
}

.team-title{font-weight:bold;margin-bottom:8px}

.member{
 display:inline-block;
 width:30px;height:30px;
 line-height:30px;
 text-align:center;
 border-radius:6px;
 margin:3px;
 font-weight:bold;
}
.m-ok{background:#2ecc71;color:#000}
.m-warn{background:#f1c40f;color:#000}
.m-bad{background:#e74c3c;color:#fff}

.event-title{font-size:20px;margin:14px 0 6px;border-bottom:1px solid #333}
.team-row{background:#111;border-radius:6px;padding:6px 10px;margin:4px 0}
.team-row.pass{color:#2ecc71}
.team-row.fail{color:#ff6b6b}

#debug{display:none;background:#000;color:#0f0;padding:10px;font-size:13px}
</style>
</head>

<body>

<div class="topbar">
  <button>ä¸€èˆ¬æ¨¡å¼</button>
  <button id="debugBtn">Debug</button>
  <div class="spacer"></div>
  <div id="time">è¼‰å…¥ä¸­â€¦</div>
</div>

<div class="container">
  <div class="panel">
    <h2>ğŸ å°éšŠå³æ™‚ç‹€æ…‹</h2>

    <div class="legend">
      <span>ğŸŸ¢ å·²å ±åˆ°ï¼‹å·²åƒè³½</span>
      <span>ğŸŸ¡ å·²å ±åˆ°æœªåƒè³½</span>
      <span>ğŸ”´ æœªå ±åˆ°ä½†å·²åƒè³½</span>
    </div>

    <div id="teams" class="team-grid">è¼‰å…¥ä¸­â€¦</div>
  </div>

  <div class="panel">
    <h2>ğŸ¯ æ¯”è³½é …ç›®</h2>
    <div id="eventPanel">è¼‰å…¥ä¸­â€¦</div>
  </div>
</div>

<pre id="debug"></pre>

<script>
/* ================= LOCKED CORE LOGIC =================
 A team is BAD (red border) ONLY IF checkinCount < 6
 Do NOT change unless rules officially change
====================================================== */

const DATA_URL =
"https://docs.google.com/spreadsheets/d/1dwK703awpcqW6A3BofDA8cjNSlER2C2Tz5wIu7wr6XQ/gviz/tq?tqx=out:json";
const MEMBERS=["A","B","C","D","E","F","G","H"];

const teamsEl=document.getElementById("teams");
const eventPanel=document.getElementById("eventPanel");
const debugEl=document.getElementById("debug");
const timeEl=document.getElementById("time");

debugBtn.onclick=()=>{
 debugEl.style.display = debugEl.style.display==="block"?"none":"block";
};

function norm(id){
 return id.replace(/[ï¼-ï¼™]/g,d=>String.fromCharCode(d.charCodeAt(0)-0xFEE0)).trim();
}

async function update(){
 try{
  const raw=await (await fetch(DATA_URL,{cache:"no-store"})).text();
  const json=JSON.parse(raw.substring(raw.indexOf("{"),raw.lastIndexOf("}")+1));
  const cols=json.table.cols.map(c=>c.label);

  const rows=json.table.rows.map(r=>{
    const o={};
    r.c.forEach((c,i)=>o[cols[i]]=c?.v??"");
    return o;
  });

  const teams={}, events={};

  rows.forEach(r=>{
    const id=r["æˆå“¡ ID"], item=r["ç°½åˆ°é …ç›®"];
    if(!id||!item) return;
    const m=norm(id).match(/^(\d+)([A-Z])$/);
    if(!m) return;

    const t=m[1].padStart(2,"0"), mem=m[2];
    teams[t]??={check:new Set(), play:new Set()};

    if(item==="é¦–æ¬¡å ±åˆ°") teams[t].check.add(mem);
    else{
      teams[t].play.add(mem);
      events[item]??={};
      events[item][t]??=new Set();
      events[item][t].add(mem);
    }
  });

  // ===== å°éšŠ =====
  teamsEl.innerHTML="";
  Object.keys(teams).sort().forEach(t=>{
    const d=teams[t];
    const checkCnt=d.check.size;
    const playCnt=d.play.size;

    const isBad = checkCnt < 6; // ğŸ”’ LOCKED

    const card=document.createElement("div");
    card.className="team-card"+(isBad?" bad":"");
    card.innerHTML=`<div class="team-title">éšŠä¼ ${t} ï½œ å‡ºå¸­ ${checkCnt} ï½œ å·²åƒè³½ ${playCnt}</div>`;

    MEMBERS.forEach(m=>{
      let cls="m-ok";
      if(d.play.has(m)&&!d.check.has(m)) cls="m-bad";
      else if(d.check.has(m)&&!d.play.has(m)) cls="m-warn";
      card.innerHTML+=`<span class="member ${cls}">${m}</span>`;
    });

    teamsEl.appendChild(card);
  });

  // ===== æ¯”è³½é …ç›® =====
  eventPanel.innerHTML="";
  Object.keys(events).forEach(item=>{
    eventPanel.innerHTML+=`<div class="event-title">${item}</div>`;
    Object.keys(events[item]).sort().forEach(t=>{
      const cnt=events[item][t].size;
      const row=document.createElement("div");
      row.className="team-row "+(cnt>=6?"pass":"fail");
      row.textContent=`${cnt>=6?"âœ…":"âŒ"} éšŠä¼ ${t} (${cnt}/6)`;
      eventPanel.appendChild(row);
    });
  });

  debugEl.textContent=JSON.stringify(rows.slice(-5),null,2);
  timeEl.textContent="æœ€å¾Œæ›´æ–°ï¼š" + new Date().toLocaleTimeString("zh-HK");

 }catch(e){
  teamsEl.innerHTML="âŒ è¼‰å…¥å¤±æ•—";
  eventPanel.innerHTML="âŒ è¼‰å…¥å¤±æ•—";
  timeEl.textContent="éŒ¯èª¤";
  console.error(e);
 }
}

update();
setInterval(update,20000);
</script>

</body>
</html>