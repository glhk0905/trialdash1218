<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<title>CC Shield å³æ™‚ç°½åˆ°ç³»çµ± (Stable)</title>

<style>
body{margin:0;font-family:system-ui;background:#0f0f0f;color:#eee}
.topbar{display:flex;gap:10px;padding:12px;background:#111;border-bottom:1px solid #333}
button{background:#333;color:#fff;border:none;border-radius:6px;padding:8px 14px;font-size:16px}
.spacer{flex:1}
#time{font-size:18px;font-weight:bold}

.container{display:grid;grid-template-columns:3fr 1fr;gap:14px;padding:14px}
.panel{background:#1b1b1b;border-radius:14px;padding:14px}

h2{margin:0 0 8px;font-size:22px}

.legend{font-size:16px;margin-bottom:10px}
.legend span{margin-right:16px}

.team-grid{
 display:grid;
 grid-template-columns:repeat(3,1fr);
 gap:12px
}

.team-card{
 background:#141414;
 border:2px solid #333;
 border-radius:12px;
 padding:12px;
 font-size:18px;
}
.team-card.bad{
 border-color:#ff5c5c;
 background:#2a0f0f;
}

.team-title{font-weight:bold;margin-bottom:8px}

.member{
 display:inline-block;
 width:30px;height:30px;
 line-height:30px;
 text-align:center;
 border-radius:6px;
 margin:3px;
 font-weight:bold;
}
.m-ok{background:#2ecc71;color:#000}
.m-warn{background:#f1c40f;color:#000}
.m-bad{background:#e74c3c;color:#fff}

/* ===== æ¯”è³½é …ç›® ===== */
.event-title{font-size:20px;margin:14px 0 6px;border-bottom:1px solid #333}

.event-team{
 background:#111;
 border-radius:8px;
 padding:8px 10px;
 margin:6px 0;
 cursor:pointer;
}
.event-team.pass{color:#2ecc71}
.event-team.fail{color:#ff6b6b}

.event-detail{
 display:none;
 font-size:14px;
 margin-top:6px;
 padding-left:10px;
}

.notice{
 color:#f1c40f;
 font-size:14px;
 margin-top:6px;
}

#debug{display:none;background:#000;color:#0f0;padding:10px;font-size:13px;white-space:pre-wrap;}
</style>
</head>

<body>

<div class="topbar">
  <button>ä¸€èˆ¬æ¨¡å¼</button>
  <button id="debugBtn">Debug</button>
  <div class="spacer"></div>
  <div id="time">åŒæ­¥ä¸­â€¦</div>
</div>

<div class="container">
  <div class="panel">
    <h2>ğŸ å°éšŠå³æ™‚ç‹€æ…‹</h2>
    <div class="legend">
      <span>ğŸŸ¢ å·²å ±åˆ°ï¼‹å·²åƒè³½</span>
      <span>ğŸŸ¡ å·²å ±åˆ°æœªåƒè³½</span>
      <span>ğŸ”´ æœªå ±åˆ°ä½†å·²åƒè³½</span>
    </div>
    <div id="teams" class="team-grid"></div>
  </div>

  <div class="panel">
    <h2>ğŸ¯ æ¯”è³½é …ç›®</h2>
    <div id="eventPanel"></div>
    <div id="status" class="notice"></div>
  </div>
</div>

<pre id="debug"></pre>

<script>
/* ========= FIXED VERSION =========
- Updated ID: 1dwK703awpcqW6A3BofDA8cjNSlER2C2Tz5wIu7wr6XQ
- Robust JSON parsing: handles prefixes like /*O_o*/
/* ================================= */

// ä½¿ç”¨äº†ä½ æä¾›çš„ Spreadsheet ID
const SPREADSHEET_ID = "1dwK703awpcqW6A3BofDA8cjNSlER2C2Tz5wIu7wr6XQ";
const DATA_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&headers=1`;

const teamsEl = document.getElementById("teams");
const eventPanel = document.getElementById("eventPanel");
const debugEl = document.getElementById("debug");
const timeEl = document.getElementById("time");
const statusEl = document.getElementById("status");
const debugBtn = document.getElementById("debugBtn");

debugBtn.onclick = () => debugEl.style.display =
 debugEl.style.display === "block" ? "none" : "block";

let lastGoodData = null;

function norm(id){
 if(!id) return "";
 // å…¨å½¢è½‰åŠå½¢
 return id.replace(/[ï¼-ï¼™]/g, d => String.fromCharCode(d.charCodeAt(0) - 0xFEE0)).trim();
}

async function fetchData(){
 try{
  const res = await fetch(DATA_URL, {cache: "no-store"});
  const text = await res.text();

  // === ä¿®æ­£é‡é»é–‹å§‹ ===
  // ç§»é™¤åŸæœ¬çš„ startsWith æª¢æŸ¥ï¼Œæ”¹ç‚ºæœå°‹ç¬¬ä¸€å€‹ { å’Œæœ€å¾Œä¸€å€‹ }
  const jsonStart = text.indexOf("{");
  const jsonEnd = text.lastIndexOf("}");

  if(jsonStart === -1 || jsonEnd === -1) {
     throw "Cannot find JSON brackets in response";
  }

  // æ“·å–ä¹¾æ·¨çš„ JSON å­—ä¸²
  const jsonString = text.substring(jsonStart, jsonEnd + 1);
  const json = JSON.parse(jsonString);
  // === ä¿®æ­£é‡é»çµæŸ ===

  lastGoodData = json;
  statusEl.textContent = "";
  return json;
 }catch(e){
  console.error("Fetch Error:", e);
  statusEl.textContent = "âš ï¸ è³‡æ–™åŒæ­¥ä¸ç©© (é¡¯ç¤ºå¿«å–ä¸­)";
  return lastGoodData;
 }
}

function render(json){
 if(!json) return;

 // ç¢ºä¿ table çµæ§‹å­˜åœ¨
 if(!json.table || !json.table.cols || !json.table.rows) return;

 const cols = json.table.cols.map(c => c?.label ?? "");
 const rows = json.table.rows.map(r => {
  const o = {}; 
  // é˜²å‘†æ©Ÿåˆ¶ï¼šç¢ºä¿ c å­˜åœ¨
  if(r.c) {
    r.c.forEach((cell, i) => {
        o[cols[i]] = cell?.v ?? "";
    });
  }
  return o;
 });

 const teams = {}, events = {};

 rows.forEach(r => {
  const id = r["æˆå“¡ ID"];
  const item = r["ç°½åˆ°é …ç›®"];
  
  if(!id || !item) return;

  const normalizedId = norm(id);
  // æ­£è¦è¡¨é”å¼å°æ‡‰ä½ çš„ ID æ ¼å¼ (æ•¸å­—+è‹±æ–‡ï¼Œä¾‹å¦‚ 01A)
  const m = normalizedId.match(/^(\d+)([A-Z])$/);
  
  if(!m) return;

  const t = m[1].padStart(2, "0"); // éšŠä¼ç·¨è™Ÿè£œé›¶
  const mem = m[2]; // æˆå“¡ä»£è™Ÿ

  // åˆå§‹åŒ–è³‡æ–™çµæ§‹
  if(!teams[t]) teams[t] = {check: new Set(), play: new Set(), all: new Set()};
  teams[t].all.add(mem);

  if(item === "é¦–æ¬¡å ±åˆ°") {
      teams[t].check.add(mem);
  } else {
    teams[t].play.add(mem);
    
    // è™•ç†æ¯”è³½é …ç›®
    if(!events[item]) events[item] = {};
    if(!events[item][t]) events[item][t] = {play: new Set()};
    events[item][t].play.add(mem);
  }
 });

 /* ===== æ¸²æŸ“å°éšŠ ===== */
 teamsEl.innerHTML = "";
 Object.keys(teams).sort().forEach(t => {
  const d = teams[t];
  const card = document.createElement("div");
  // é€™è£¡å‡è¨­æ¯éšŠ 6 äººï¼Œå°‘æ–¼ 6 äººè¦–ç‚º bad
  card.className = "team-card" + (d.check.size < 6 ? " bad" : "");
  
  card.innerHTML = `<div class="team-title">éšŠä¼ ${t} ï½œ å‡ºå¸­ ${d.check.size} ï½œ å·²åƒè³½ ${d.play.size}</div>`;
  
  // æ¸²æŸ“ A, B, C... æˆå“¡
  [...d.all].sort().forEach(m => {
    let cls = "m-ok";
    if(d.play.has(m) && !d.check.has(m)) cls = "m-bad"; // æœ‰ç©æ²’ç°½åˆ°
    else if(d.check.has(m) && !d.play.has(m)) cls = "m-warn"; // æœ‰ç°½åˆ°æ²’ç©
    
    card.innerHTML += `<span class="member ${cls}">${m}</span>`;
  });
  teamsEl.appendChild(card);
 });

 /* ===== æ¸²æŸ“æ¯”è³½é …ç›® ===== */
 eventPanel.innerHTML = "";
 Object.keys(events).forEach(item => {
  eventPanel.innerHTML += `<div class="event-title">${item}</div>`;
  
  Object.keys(events[item]).sort().forEach(t => {
    const playList = [...events[item][t].play].sort();
    // æ‰¾å‡ºæœ‰ç°½åˆ°ä½†æ²’ç©é€™å€‹é …ç›®çš„äºº
    const notPlayList = [...teams[t].check].filter(m => !events[item][t].play.has(m)).sort();

    const row = document.createElement("div");
    // å‡è¨­æ»¿ 6 äººæ‰ç®— pass
    row.className = "event-team " + (playList.length >= 6 ? "pass" : "fail");
    row.textContent = `éšŠä¼ ${t} (${playList.length}/6)`;

    const detail = document.createElement("div");
    detail.className = "event-detail";
    detail.innerHTML = `âœ… å·²åƒè³½ï¼š${playList.join(" ") || "-"}<br>ğŸŸ¡ å·²ç°½æœªç©ï¼š${notPlayList.join(" ") || "-"}`;

    row.onclick = () => detail.style.display =
      detail.style.display === "block" ? "none" : "block";

    eventPanel.appendChild(row);
    eventPanel.appendChild(detail);
  });
 });

 debugEl.textContent = JSON.stringify(rows.slice(-3), null, 2); // åªé¡¯ç¤ºæœ€å¾Œ3ç­†debug
 timeEl.textContent = "æœ€å¾Œæ›´æ–°ï¼š" + new Date().toLocaleTimeString("zh-HK");
}

async function update(){
 const json = await fetchData();
 render(json);
}

// å•Ÿå‹•
update();
// æ¯ 10 ç§’æ›´æ–°ä¸€æ¬¡ (åŸæœ¬æ˜¯ 20000msï¼Œç¨å¾®åŠ å¿«ä¸€é»åæ‡‰)
setInterval(update, 10000);
</script>

</body>
</html>